# 配置与码表

小小输入法的官方文档中已经对小小输入法进行了详细的说明，本章只对其中的重点进行再次梳理，如有疑问请阅读官方文档（`程序目录/doc/yong.chm`）。

## 修改配置文件

可以使用图形化配置程序来快速配置小小输入法，也可以直接修改配置文件。修改完成后，需要重启（热重启即可）小小输入法以使设置生效。

### 公共配置文件

图形化配置程序实际上是对公共配置文件`$yongdir/yong.ini`的部分项目进行修改。直接编辑该文件，可以定制更多选项。

> * 本文档中，使用`$yongdir`指代`程序目录/.yong`目录（Android版就是`sdcard/yong/.yong`）。但对于Windows版本的小小输入法，若其安装在`C:/Program Files (x86)`或`C:/Program Files`时，则变成`%AppData%/yong`目录，在Windows上可以通过命令直通车`ooml`→`配置目录`来快速定位到该目录。

配置文件采用ini格式（**UTF-8编码**），形如：

```ini
[IM] #段(Session),下方的键值对都属于此段。该段与主程序有关
default=0 #键值对,属于IM段
0=xkjd6
1=pinyin
#...

[main] #新的段,段之间是并列关系。该段与输入法状态条有关
noshow=0 #键值对,属于main段
menu=menu.ini #表示路径时可用相对路径,根目录为主程序(yong.exe)所在目录,如本例menu.ini和./menu.ini都表示根目录下的menu.ini文件
#...

[input] #该段与候选窗有关
#...

[key] #该段与热键有关
#...

[table] #该段与码表有关。该段之后的段与方案有关
#...

[xkjd6] #方案ID
name=键道6 #必填，方案显示名
engine=libmb.so #必填，码表类型，普通本地码表用libmb.so
arg=mb/xkjd6/xkjd6_arg.txt #必填，主码表路径
#...

[pinyin]
name=拼音 #必填，方案显示名
engine=libcloud.so #必填，码表类型，云拼音码表用libcloud.so
arg=sogou #必填，主码表路径，云拼音码表可选sogou/qq/baidu
#...

#...
```

完整的配置文件范例，可参考本项目的`程序目录/yong.ini`文件。

大部分设置项，如果在`$yongdir/yong.ini`中未定义，则会顺沿到`程序目录/yong.ini`中寻找。

但某些设置项，如`[IM]`段下的0，1，……等（本文档称之为**方案序号**），以及`[table]`段后的`[方案ID]`（如`[xkjd6]`）段，如果找不到，就不会顺沿。`[IM]`段下的方案序号键的值匹配相应的`[方案ID]`段。主程序会加载这些方案，用户可以快速地在这些方案中进行切换（通过输入法状态条，或者图形化配置程序，或者快捷键<kbd>Ctrl</kbd><kbd>Shift</kbd><kbd>H</kbd>）。

> * 方案序号键应连续。如果有间断，则间断点后的序号会被忽略。
> * 如果方案序号键值没有对应的`[方案ID]`段，切换到该方案时可能导致程序崩溃。

### 专属配置文件

小小输入法允许为每个方案指定专属的配置文件，以获得更高的灵活性。

方法是在公共配置文件（如`$yongdir/yong.ini`）的`[方案ID]`段中，用overlay键值指定一个专属于该方案的配置文件。当该方案被激活时，主程序会以比`$yongdir/yong.ini`更高的优先级加载专属配置文件。

专属配置文件的格式和公共配置文件相同，但是请**不要在专属配置文件中设置序号键和`[方案ID]`段**，以免发生不可预料的行为。

## 修改码表文件

码表文件分三类：造词文件、本地码表文件、在线码表。

### 造词文件

小小输入法自带造词和调频功能，与之相关的造词文件位于`$yongdir`目录，是**GB18030编码**的文件，例如`xkjd6.usr`。对于普通用户，可不需要手动修改此文件，而是通过输入法自带的功能来造词、删词、调频等：

<!-- tabs:start -->

#### ** Windows **

1. 手动造词：把想造的词打上屏或复制→<kbd>Ctrl</kbd><kbd>Insert</kbd>→用<kbd>↑</kbd>/<kbd>↓</kbd>选中目标词→检查并修改编码→回车确认。
2. 自动造词：软件会自动将用户打出的字组词并编码，成为临时词，临时词在输入法重启后会丢失，但如果用户在丢失前用正确编码打出这个临时词，该词就会被记录到造词文件。
3. 删词：把自造词打出到候选栏，然后用<kbd>Ctrl</kbd><kbd>Delete</kbd>。⚠注意，此功能在这种情况下会失效：当想删的词不是自造词（而是码表里的词），**且**没有重码（重码是指有两个以上不同词条的编码完全相同）时。
4. 手动调频：打出要调频的词到候选栏→用<kbd>↑</kbd>/<kbd>↓</kbd>选中目标词→用<kbd>Ctrl</kbd><kbd>↑</kbd>/<kbd>↓</kbd>调频。⚠注意，此功能仅在发生重码时有效。
5. 自动调频：默认未开启，此处不介绍。

#### ** Android **

1. 手动造词：把想造的词的逐字打上屏，但保留最后一个字在候选栏（不要上屏）→长按<kbd>g</kbd>进入加词面板→把最后一个字上屏→点<kbd>造词</kbd>→用<kbd>↑</kbd>/<kbd>↓</kbd>选中目标词→检查并修改编码→按<kbd>↵</kbd>确认。
2. 自动造词：经测试，Android版开启此功能可能会导致程序崩溃，因此不启用。
3. 删词：把想删的词打到候选栏→长按<kbd>g</kbd>进入加词面板→点<kbd>删词</kbd>。⚠注意，此功能在这种情况下会失效：当想删的词不是自造词（而是码表里的词），**且**没有重码（重码是指有两个以上不同词条的编码完全相同）时。
4. 手动调频：打出要调频的词到候选栏→用<kbd>↑</kbd>/<kbd>↓</kbd>选中目标词→用<kbd>←</kbd>/<kbd>→</kbd>调频。⚠注意，此功能仅在发生重码时有效。
5. 自动调频：默认未开启，此处不介绍。

> Android版本目前的加词、删词、调频等操作与Windows版有所不同，未来可能会进行修改使它们统一。

<!-- tabs:end -->

### 本地码表文件

内置方案的本地码表文件位于`程序目录/mb/方案ID`目录，必须是**GB18030编码**的txt文件。

内置方案的本地码表文件在每次版本更新时都会被覆盖，**不建议用户修改**。如果你想折腾自己的码表，请建立自己的方案。

### 在线码表

某些方案（如键道）的活跃用户创建的在线协作文档，所有人都可以参与维护。打开在线码表（`oomb`→`在线码表`，或通过输入法状态条右键菜单），按规则提交新词，就可能在下次版本更新时被收录到本地码表文件。

## 方案管理和定制

### 卸载/加载方案

在图形化配置程序中，可以自动卸载/加载编码方案：

* 卸载方案：在左侧树状视图中，右击某个方案，在右键菜单中点<kbd>删除</kbd>。

* 加载方案：在左侧树状视图中，右击<kbd>输入法</kbd>，在右键菜单中选择要安装的方案。注意只有在`程序目录/entry`目录下拥有入口文件的方案才可被加载，如果没有入口文件，那么卸载后就无法在图形化配置程序中加载回来。

也可以手动卸载/加载编码方案：

* 卸载方案：修改`$yongdir/yong.ini`，将该方案的序号~方案ID键值对从`[IM]`段中剔除（并重新编排序号），同时删除`[table]`段后的该`[方案ID]`段。
* 加载方案：修改`$yongdir/yong.ini`，将该方案的`[方案ID]`段（读取自该方案的入口文件）追加到`[table]`段之后，并在`[IM]`段中追加该方案的序号~方案ID键值对。

> Android版本目前无法自动卸载/加载方案，只能手动操作。

### 建立自己的方案

一个方案最少应包括主码表文件和入口文件。

* 主码表文件：参考下面的范例。注意自己方案的主码表文件最好不要放在`程序目录/mb`中，以免被覆盖。

  ```ini
  # 码表默认编码是GB18030，但也支持UTF8
  #encode=UTF-8
  # 码表的名字，不会显示在主程序中
  name=星空键道6S
  # 参与编码的按键，最多60个（本文以编码指代“缓冲区编码”，而非码表中的“词条编码”）
  key=abcdefghijklmnopqrstuvwxyz;.',
  # len和commit=X Y Z：
  # ①len和X：当前编码长度达到len时，若此时的候选项唯一且词库中无后续编码，是否自动上屏。0为是（默认），1为否（后续可能进入Y和Z判定）。
  # ②Y和Z：下一码即将导致空码时，若当前码长<Y，就阻止下一码进入缓冲区。而若当前码长≥Y（默认Y=0），分三种情况：
  #    1)(默认)Z=0：上屏当前编码对应的候选项，下一码进入缓冲区；
  #    2)Z>0且第Z+1码~下一码不是空码：上屏当前编码的第1码~第Z码对应的候选项，第Z+1码~下一码留在缓冲区；
  #    3)Z>0且第Z+1码~下一码是空码：按Z=0处理。
  len=12
  #commit=0 0 0
  # 以这些符号开始的编码，唯一时自动上屏。最多9个，或者直接用*表示任意字符。
  pull=;o
  # 以这些符号终止的编码，唯一时自动上屏。最多9个
  #push=viuoa
  # 笔画键引导下的横竖撇点折，经测试此项无效
  #bihua=viuoa
  # 万能键，落后于配置文件中[table]段的同名设置，但此处必须赋予一个值，否则会导致配置文件中的设置失效。
  # 只能用半角（设完后即使打全角也会变成万能键），区分上下档，不需包含在key中，不能和笔画引导键重复或者用?（否则万能键不能用于首码）
  wildcard=`
  # 首个编码禁用万能键
  #dwf=0
  # 词条编码完全匹配缓冲区编码时，才会显示为候选项。0:关闭 1:开启
  #match=0
  # 压缩显示模式，即当缓冲区编码匹配两个相同词条，且词条编码互为简全时，全码那个不显示为候选项（后续仍可打出）。0:关闭 1:开启
  #compact=0
  # 出简不出全，即检查码表，若发现有两个记录的词条相同、词条编码互为简全，则抛弃全码记录（无法打出）。0:关闭 1:开启
  #simple=0
  # 编码提示，0:关闭(优先于配置文件的[input]hint) 1:开启(落后于配置文件的[input]hint)
  #hint=
  # 编码为空码时的处理方式，落后于配置文件[方案ID]中的同名设置。0:不清空编码  1:清空编码  2以上:编码到达该长度时才清空  全码码长len+1:清空但保留最后一位编码
  #auto_clear=0
  # 预处理码表中的记录，按词条编码进行排序。0:开启 1:关闭(用于王林快码，关闭后很多其他功能会失效，慎用)
  #nsort=0
  # 对重码词自动调频，落后于配置文件[IM]auto_move。0:禁用 1:快速调频(一次到顶) 2:慢速调频(逐渐冒泡)
  #auto_move=0
  # 编码若以此开头，则不参与调频。例如nomove=iz，则iz开始编码的词不参与自动调频
  #nomove=
  # 英语码表，0:否 1:是，英语码表格式参考自带的英语输入法
  #english=0
  # 拼音码表，0:否 1:是，拼音码表格式参考自带的拼音输入法
  #pinyin=0
  # 永码(或双拼形类)码表，0:否 1:是，若开启，则①按间接辅码键Tab会上屏当前编码的第1码~第Z码对应的首选项，②2字以上词不要含形辅，软件会根据单字码表自动计算末字的直接辅码（1位）。辅码仍然出现的重码将不会触发自动调频
  #yong=0
  # 双拼类方案的切分长度，可不设，全拼不应设
  #split=2~7
  # 用于王林快码，对前n个候选进行简码处理
  #sloop=n
  # 辅码码表，两种格式①直接辅助码:“assist=引导键 码表路径”，引导键规则类似万能键，码表路径引用全拼码表可形成临时拼音模式的效果 ②TAB间接辅助码:“assist=码表路径 编码中辅码起始位置”
  #assist=e mb/pinyin/pinyin_arg.txt
  # 分码表文件（或目录）。项目越靠前，优先级越高（目录下的码表文件优先级按名字升序）。落后于配置文件[方案ID]中的同名设置。
  #dicts=mb/xkcommon mb/xkjd6s
  # 造词文件，必位于$yongdir下，不像码表文件一样可以使用子目录；不设则使用默认的user.txt
  user=xkjd6s.usr
  #编码若以此开头，则不参与造词
  #skip=
  #造词规则
  code_e2=p11+p12+p21+p22+p13+p23
  code_e3=p11+p21+p31+p13+p23+p33
  code_a4=p11+p21+p31+n11+p13+p23+p33+n13
  [DATA]
  b 不
  #接下来就是单字码表了，省略
  ```

  

* 入口文件：入口文件是一个名字随意的ini文件（**UTF-8编码**），必须放在`程序目录/entry`目录下。入口文件的内容就是该方案的`[方案ID]`段，格式如下：

  ```ini
  # $yongdir/yong.ini中不能存在同名的段，否则无法识别
  [xkjd6s]
  #方案显示名，会显示在图形配置程序和输入法皮肤上
  name=键道6S
  #码表类型，本地码表填libmb.so，在线拼音码表填libcloud.so
  engine=libmb.so
  #主码表路径，本地码表填txt路径，在线拼音码表填baidu(默认)/sogou/qq/google（现已全部失效）
  arg=mb/xkjd6s/xkjd6s_arg.txt
  #当切换到该方案时，以最高优先级加载overlay配置文件里的设置
  overlay=mb/xkjd6s/xkjd6s_overlay.ini
  #连续输入单字时，如果碰到能成词的，就提示（这个会跟 $[显示词条]实际词条 冲突）
  tip_exist=1
  #直接输入单字时，如果碰到简码存在，就提示，这个值的大小代表识别前几个候选作为简码。
  tip_simple=1
  #分码表文件（或目录）。项目越靠前，优先级越高（目录下的码表文件优先级按名字升序）。优先于主码表中的同名设置。
  dicts=mb/xkjd6s mb/xkcommon
  #用多线程加载码表
  thread=1
  #键位图
  keymap=键位图 xkjd6_keymap.png 1 0
  #编码为空码时的处理方式，优先于主码表中的同名设置。none:跟随主码表 0:不清空编码  1:清空编码  2以上:编码到达该长度时才清空  全码码长len+1:清空但保留最后一位编码
  #auto_clear=
  #自动进入英文模式。0:关闭 1:当前编码为空码且长度不超过全码码长len时自动进入 2:空码时自动进入
  #auto_english=
  #独立于主码表中assist的另一个辅助码表，与assist不同的是quick里的字词不会在候选项中提示全码
  #quick=
  #固顶码表文件，见小小用户手册
  #pin=
  #皮肤
  #skin=
  #自动造词。实时地把用户刚打过的前X个字~前Y个字(X<=Y)记忆为临时词，并根据主码表文件中的造词码为临时词自动编码。如果Z=0(默认)，则当输入法被刷新时，临时词会丢失；如果Z=1，则当用户成功地用自动编码打出临时词时，该词会被保存到主码表文件中定义的造词文件。
  auto_phrase=2,4,1
  #联想功能，参见帮助文档
  #assoc_???
  ```
  
  如果是拼音类输入方案，有一些额外的设置：
  
  ```ini
  # $yongdir/yong.ini中不能存在同名的段，否则无法识别
  [pinyin]
  #方案显示名，会显示在图形配置程序和输入法皮肤上
  name=拼音
  #码表类型，本地码表填libmb.so，在线拼音码表填libcloud.so
  engine=libmb.so
  #主码表路径，本地码表填txt路径，在线拼音码表填baidu(默认)/sogou/qq/google（现已全部失效）
  arg=mb/pinyin/pinyin_arg.txt
  #仅适用于在线拼音码表，可以指定一个本地的单字码表
  #pinyin=mb/pinyin/pinyin_arg.txt
  #仅适用于在线拼音码表，可以额外指定一个本地码表（编码必须在26字母范围内，长度不能超过7码）
  #user=mb/xkcommon/xkcommon_dict_o引导.txt
  #仅适用于在线拼音码表，指定一个代理服务器（不能用用户名和密码）
  #proxy=http://127.0.0.1:1315
  #仅适用于在线拼音码表，设置双拼
  #sp=
  #仅适用于拼音码表，开启简拼功能
  simple=1
  #仅适用于拼音码表，语料库文件
  predict=mb/pinyin/pypre.bin
  #其他设置项基本和本地码表相同
  dicts=mb/pinyin mb/xkcommon
  #当切换到该方案时，以最高优先级加载overlay配置文件里的设置
  overlay=mb/pinyin/pinyin_overlay.ini
  ```
  
  准备好入口文件后，就可以在图形化配置程序中加载自己的方案了。但是，Android版本目前不支持在图形化配置程序中加载方案，因此需要手动操作，方法见上一小节。

